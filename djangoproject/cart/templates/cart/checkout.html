{% extends 'posts/layout.html' %}
{% load static %}
{% block content %}

{% if not billing_profile %}
	<div class="row">
		<div class="col s12 l6 offset-l2">
			{% include 'views/snippets/form.html' with form=login_form next_url=request.build_absolute_uri %}
		</div>
		<div class="col s12 l3">
			<p>Continue as guest</p>
			{% url "guest_register" as guest_register_url %}
			{% include 'views/snippets/form.html' with form=guest_form next_url=request.build_absolute_uri action_url=guest_register_url %}
		</div>
	</div>
{% else %}
	{% if not object.shipping_address %}
		{% url "guest_register" as guest_register_url %}
		<div class="row">
			<div class="col s12 l5 offset-l3">
				<p><b>Shipping Address</b></p>
			{% url "checkout_address_create" as checkout_address_create %}
			{% include 'addresses/form.html' with form=address_form next_url=request.build_absolute_uri action_url=checkout_address_create address_type='shipping' %}
			</div>
		<div class="col s12 l3">
			{% url "checkout_address_reuse" as checkout_address_reuse %}
			{% include 'views/snippets/prev_addresses.html' with address_qs=address_qs next_url=request.build_absolute_uri address_type='shipping' action_url=checkout_address_reuse %}
		</div>
		</div>
		{% elif not object.billing_address %}
		<div class="row">
			<div class="col s12 l5 offset-l3">
				<p><b>Billing Address</b></p>
			{% url "checkout_address_create" as checkout_address_create %}
			{% include 'addresses/form.html' with form=address_form next_url=request.build_absolute_uri action_url=checkout_address_create address_type='billing' %}
			</div>
		<div class="col s12 l3">
			{% url "checkout_address_reuse" as checkout_address_reuse %}
			{% include 'views/snippets/prev_addresses.html' with address_qs=address_qs next_url=request.build_absolute_uri address_type='billing' action_url=checkout_address_reuse %}
		</div>
		</div>
		{% else %}
			{% if not has_card %}
			<div class="row">
				<div class="col s12 l4 offset-l4">
			<script src="https://js.stripe.com/v3/"></script>
			<h4>Add Payment Method</h4>
			 <form class="payment-form" action="{% url 'billing-payement-method-endpoint' %}" data-endpoint="{% url 'billing-payement-method-endpoint' %}" method="POST" id="payment-form" data-token="{{ publish_key }}"
			 data-next-url="{% if next_url %} {{next_url}} {% endif %}">{% csrf_token %}
			  <div class="form-row">
			    <label for="card-element" >
				 Credit or debit card
			    </label>
			    <div id="card-element" class="input-field ">
			<!--   Stripe Element will be inserted here. -->
			    </div>

			    <!-- Used to display form errors. -->
			    <div id="card-errors" role="alert"></div>
			  </div>

			  <button class="btn">Add Payment Method</button>
			</form> 
		   			
				</div>
			</div>
			{% else %}
		<div class="row">
			<div class="col s12 l6 offset-l4">
				<h5>Finalize Checkout</h5>
				<p><b>Cart Items: </b> {% for product in object.cart.products.all %} {{product}} {% if not forloop.last %}, {% endif %} {% endfor %}</p>
				<p><b>Shipping Address: </b> {{ object.shipping_address.get_address  }}</p>
				<p><b>Billing Address: </b> {{ object.shipping_address.get_address }}</p>
				<p><b>Payment Method: </b> {{ billing_profile.default_card }} (<a href="{{billing_profile.get_payment_method_url}}?next={{build_absolute_uri}}">Change</a>)</p>
				<p><b>Cart Total: </b> {{ object.cart.total }}</p>
				<p><b>Shipping Total: </b> {{ object.shipping_total }}</p>
				<p><b> Order Total: </b> {{ object.total }} </p>
				<form class="form" method="POST" action="">
					{% csrf_token %}
					<button type="submit" class="btn">Checkout</button>
				</form>
			</div>
		</div>
		{% endif %}
		{% endif %}
{% endif %}
{% endblock %}